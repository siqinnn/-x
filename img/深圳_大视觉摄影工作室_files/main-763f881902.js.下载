"use strict";function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function chat(){function e(){w()}function n(){var e=c()?window.DBKF.configs.mwindowrule:window.DBKF.configs.windowrule;e.brandAds&&""!==$.trim(e.brandAds)&&Message.addAdsMessage(e.brandAds)}function o(e){var o=arguments.length<=1||void 0===arguments[1]?!0:arguments[1],a=e;if(window.DBKF.configs.windowrule){if(o===!1)return void l();r();var s=c()?window.DBKF.configs.mwindowrule:window.DBKF.configs.windowrule;e.worker_avatar?window.avatarUrl=window.DBKF.configs.COMPANY_IMAGE_CDN+"/"+e.worker_avatar+"!square":s.companyLogo?window.avatarUrl=window.DBKF.configs.COMPANY_IMAGE_CDN+"/"+s.companyLogo+"!square":window.avatarUrl="//uworker.yunque360.com/assets/images/blank-avatar.png",$("#avatar-img").attr("src",window.avatarUrl),C(s),window.parent.postMessage("$CMD_AGENT_AVATAR="+window.avatarUrl,"*"),n(),t(),l(),s&&s.showDialogTitle!==!1&&$(".box-header .connected .agent-name").text(a.worker_nickname),window.DBKF.agentName=a.worker_nickname,window.parent.postMessage("$CMD_AGENT_NAME="+a.worker_nickname,"*")}else $.ajax({type:"GET",dataType:"json",cache:!1,url:window.DBKF.configs.POLLING_SITE+"/company?id="+window.DBKF.configs.COMPANY_ID,success:function(e,s){window.DBKF.configs.windowrule=JSON.parse(e.data.windowrule||"[]"),window.DBKF.configs.mwindowrule=JSON.parse(e.data.mwindowrule||"[]"),window.DBKF.configs.uirule=JSON.parse(e.data.uirule||"[]");var d=c()?window.DBKF.configs.mwindowrule:window.DBKF.configs.windowrule,u=d.pageWindowTitle?d.pageWindowTitle:"在线咨询 "+e.data.name;window.parent.postMessage("$COMPANY_INFO_ANNOTHER="+u,"*"),t(),l(),o!==!1&&(r(),i(a),window.parent.postMessage("$CMD_AGENT_AVATAR="+window.avatarUrl,"*"),$("#avatar-img").attr("src",window.avatarUrl),C(d),n(),d&&d.showDialogTitle!==!1&&$(".box-header .connected .agent-name").text(a.worker_nickname),window.DBKF.agentName=a.worker_nickname,window.parent.postMessage("$CMD_AGENT_NAME="+a.worker_nickname,"*"))}});o!==!1&&(window.DBKF.agentName=a.worker_nickname,setTimeout(function(){$(".box-header .connect-info").hide(),$(".box-header .connected").show()},0))}function i(e){var n=e.worker_avatar||e.avatar,o=c()?window.DBKF.configs.mwindowrule:window.DBKF.configs.windowrule;n?window.avatarUrl=window.DBKF.configs.COMPANY_IMAGE_CDN+"/"+n+"!square":o.companyLogo?window.avatarUrl=window.DBKF.configs.COMPANY_IMAGE_CDN+"/"+o.companyLogo+"!square":window.avatarUrl="//uworker.yunque360.com/assets/images/blank-avatar.png"}function t(){a();var e=c()?window.DBKF.configs.mwindowrule:window.DBKF.configs.windowrule;if(e.showDialogTitle!==!1||e.dialogSubTitle||($(".agent-name").hide(),$(".company-name").css("top",0),$(".company-name").css("bottom",0),$(".company-name").css("font-size","14px"),$(".company-name").css("line-height","60px"),Utils.isFixedViewportMobile()&&($(".company-name").css("font-size","28px"),$(".company-name").css("line-height","120px"))),e.showDialogTitle===!1&&e.dialogSubTitle&&$(".agent-name").text(e.dialogSubTitle),e.showSoundSwitcher===!1&&$("#play-sound-icon").hide(),e.showSendPicBtn===!1&&$("#send-image-btn").hide(),e.showEmojiBtn===!1&&$("#emoji-btn").hide(),e.showShakeBtn===!1&&$("#send-vibration-btn").hide(),!Utils.islowerIE9()&&"custom"===e.backgroundStyle&&e.customBackground){if(window.hasSetBg)return;window.hasSetBg=!0;var n=window.DBKF.configs.COMPANY_IMAGE_CDN+"/"+e.customBackground+"!default";$(".chat-history-wrapper").addClass("has-bg"),$("head").append("<style>.chat-history-wrapper::before {background-image: url('"+n+"')}</style>")}Utils.islowerIE9()||"heart"!==e.backgroundStyle||$("#chat-history").addClass("heart-bg"),c()&&window.DBKF.configs.COMPANY_ID&&"c9j7lej2dfdu"==window.DBKF.configs.COMPANY_ID&&$(".yunque-link").click(function(e){e.preventDefault()})}function a(){var e=window.DBKF.configs.mwindowrule;if(c()&&"single"===e.textareaStyle){"bottom"===e.yqLogoPosition&&$(".chat-box").addClass("single-bottom"),"center"===e.yqLogoPosition&&$(".chat-box").addClass("single-center");var n=s(e.yqLogoPosition);$(".normal").html(n)}}function s(e){return"center"===e?'\n      <div class="center-bar">\n        <div class="pull-left">\n          <a>\n            <i class="iconfont" id="send-image-btn">&#xe66e;</i>\n          </a>\n          <a style="margin-left: 5px;">\n            <i class="iconfont" id="emoji-btn" onclick="triggerEmoji(event)">&#xe79e;</i>\n          </a>\n          <a style="margin-left: 5px;">\n            <i class="iconfont" id="send-vibration-btn">&#xe820;</i>\n          </a>\n          <input type="file" id="image-upload-input" accept="image/*" style="display: none">\n\n        </div>\n        <div class="pull-right yunque-center-logo" style="padding-right: 10px;color: #b7bac2;">\n          <a href="http://yunque360.com" target="_blank">\n            <i class="icon-gray-bird"></i>\n            '+langProvider.getText("yunque")+'</a>\n        </div>\n      </div>\n\n      <div class="actions" id="actions-div">\n        <textarea id="input-textarea" rows="1" autocomplete="off" placeholder="'+langProvider.getText("type-here")+'"></textarea>\n\n        <div class="pull-right">\n          <input type="button" id="send-btn" value="'+langProvider.getText("send")+'" class="active">\n        </div>\n      </div>\n\n      ':"bottom"===e?'\n        <div class="actions" id="actions-div">\n            <div class="btn-holders">\n            <a >\n                <i class="iconfont" id="emoji-btn" onclick="triggerEmoji(event)">&#xe79e;</i>\n              </a>\n              <a style="margin-left: 5px;">\n                <i class="iconfont" id="send-image-btn">&#xe66e;</i>\n              </a>\n\n\n              <input type="file" id="image-upload-input" accept="image/*" style="display: none">\n            </div>\n            <div class="text-holder">\n              <textarea id="input-textarea" class="single-bottom-textarea" rows="1" autocomplete="off" placeholder="'+langProvider.getText("type-here")+'"></textarea>\n              <input type="button" id="send-btn" value="'+langProvider.getText("send")+'" class="active">\n            </div>\n\n            <div class="clear-both"></div>\n\n        </div>\n        <div class="box-footer">\n        <div class="contact-info">\n            <a href="http://yunque360.com" target="_blank" id="yunque-link">\n                <i class="icon-graybird"></i>\n                <span>'+langProvider.getText("made-by-yunque")+"</span>\n            </a>\n        </div>\n    </div>\n        ":void 0}function r(){if(!c()){var e=window.DBKF.configs.windowrule.windowStyle;x()&&"undefined"!=typeof window.DBKF.configs.windowrule.frame_windowStyle&&(e=window.DBKF.configs.windowrule.frame_windowStyle),"standard"===e&&(window.parent.postMessage("$IS_STANDARD_WINDOW","*"),$(".box-body").addClass("standard"),$(".chat-box").addClass("standard"),window.DBKF.configs.windowrule.companyAd&&$("#side-window-logo").attr("src",window.DBKF.configs.COMPANY_IMAGE_CDN+"/"+window.DBKF.configs.windowrule.companyAd+"!default"),window.DBKF.configs.windowrule.companyInfo&&$("#side-window-companyInfo").text(window.DBKF.configs.windowrule.companyInfo),window.DBKF.configs.windowrule.companyNumber&&$("#side-window-companyNumber").text(langProvider.getText("mobile-field")+window.DBKF.configs.windowrule.companyNumber),window.DBKF.configs.windowrule.companyAddress&&$("#side-window-companyAddress").text(langProvider.getText("location-field")+window.DBKF.configs.windowrule.companyAddress))}}function c(){var e=!1;return function(n){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|BDNuomiAppAndroid/i.test(n)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(n.substr(0,4)))&&(e=!0)}(navigator.userAgent||navigator.vendor||window.opera),e||window.screen&&window.screen.width&&window.screen.width<=720&&(e=!0),e}function d(e){var n=document.createElement("style");n.type="text/css",n.styleSheet?n.styleSheet.cssText=e:n.appendChild(document.createTextNode(e)),document.getElementsByTagName("head")[0].appendChild(n)}function l(){var e=window.DBKF.configs.windowrule&&window.DBKF.configs.windowrule.windowColor?window.DBKF.configs.windowrule.windowColor:"#5579ED",n=window.DBKF.configs.mwindowrule&&window.DBKF.configs.mwindowrule.windowColor?window.DBKF.configs.mwindowrule.windowColor:"#5579ED";e=c()?n:e;window.document.styleSheets[0];d(".chat-box .box-header { background-color: "+e+"; }\n                #send-btn.active { background-color: "+e+"!important; }\n                #submit-comment-btn { background-color: "+e+"; }\n                .msg-client .bubble { background-color: "+e+"; }\n                .msg-client .bubble .arrow { border-left: 6px solid "+e+"; }\n                #submit-comment-btn { background-color: "+e+"!important; }\n                #icon-comment-success {color: "+e+"!important}\n        ")}function u(){$.ajax({type:"GET",dataType:"json",cache:!1,url:window.DBKF.configs.POLLING_SITE+"/company?id="+window.DBKF.configs.COMPANY_ID,success:function(e,n){var o=JSON.parse(e.data.windowrule||"[]"),i=JSON.parse(e.data.mwindowrule||"[]"),t=c()?i:o;if(t.frame_background)var a=window.DBKF.configs.COMPANY_IMAGE_CDN+"/"+t.frame_background+"!2k";window.parent.postMessage("$CMD_FRAME_BACKGROUND="+a,"*");var s="";s=t&&t.dialogTitle?t.dialogTitle:"欢迎咨询!",$(".box-header .connected .company-name").text(s),document.title=s}})}function m(e){$(".box-header .connected .agent-name").text(e.nickname),window.DBKF.agentName=e.nickname,i(e),$("#avatar-img").attr("src",window.avatarUrl),$(".box-header .connect-info").hide(),$(".box-header .connected").show(),window.parent.postMessage("$CMD_AGENT_AVATAR="+window.avatarUrl,"*"),window.parent.postMessage("$CMD_AGENT_NAME="+e.nickname,"*")}function w(){$("body").on("click","#send-vibration-btn",function(){p()}),$("body").on("click","#send-btn",function(){$("#input-textarea").blur(),f()}),$("body").on("keyup","#input-textarea",function(e){return 13===e.which&&f(),!0}),c()&&$("body").on("blur","#input-textarea",function(e){window.setTimeout(function(){window.scrollTo(0,10)},300),window.parent.postMessage("$YUNQUE_SLIGHT_SCROLL_WINDOW","*")}),$("body").on("keydown","#input-textarea",_(v,2e3)),$("#input-textarea").change(),$("body").on("click","#send-image-btn",function(){$("#image-upload-input").click()}),$("body").on("change","#image-upload-input",function(){g();var e=$("#image-upload-input");e.replaceWith(e=e.clone(!0))}),$(".chat-history").on("click",".msg-history",function(e){var n=$(e.target).attr("id");Message.addHistoryMsgs(n)}),$("#input-textarea").focus(function(){Utils.isMobile()||$(".center-bar").addClass("shadow")}),$("#input-textarea").blur(function(){$(".center-bar").removeClass("shadow")}),$("body").on("focus",".single-bottom-textarea",function(){$(".btn-holders").hide(),$("#actions-div").addClass("focus")}),$("body").on("blur",".single-bottom-textarea",function(){$(".btn-holders").show(),$("#actions-div").removeClass("focus")})}function g(){D.sendImage(document.getElementById("image-upload-input").files[0]).then(function(e){var n=Date.now(),o={cmd:"image",body:e,cmicrotime:n};Message.addImageMessage(o),E.send(o)})}function p(){var e=Date.now(),n={cmd:"shake",body:"",cmicrotime:e};Sound.playSentMessage(),$("body").addClass("shake"),setTimeout(function(){$("body").removeClass("shake")},1e3),Message.addShakeMessage(n),E.send(n)}function f(){h();var e=document.getElementById("input-textarea");if(""!==e.value.trim()){var n=Date.now(),o={body:e.value,cmicrotime:n};Message.addTempClientMessage(o),E.send({cmd:"user",body:renderEmoji(e.value),cmicrotime:n}),e.value="",Sound.playSentMessage(),Message.scrollBottom()}}function h(){window.parent.postMessage("$YUNQUE_BAIDU_SEND_MESSAGE","*")}function v(){var e=window.previewMsgStore?window.previewMsgStore:"",n=document.getElementById("input-textarea");if(""!==n.value.trim()&&n.value!==e){window.previewMsgStore=n.value;var o=Date.now();E.send({cmd:"typing",body:renderEmoji(n.value),cmicrotime:o})}}function y(e){var n=arguments.length<=1||void 0===arguments[1]?!1:arguments[1];for(var o in e){var i=e[o];b(i,n)}}function b(e,n){if("user"===e.cmd){if(0!==$("#client-"+e.cmicrotime).length)return;Message.addClientMessage(e,n)}if("worker"===e.cmd&&(e.agentName=window.DBKF.agentName,Sound.playNewMessage(),Message.addAgentMessage(e,n)),"autoreply"===e.cmd&&(e.agentName=window.DBKF.agentName,Sound.playNewMessage(),Message.addAgentMessage(e,n)),"disconnect"===e.cmd&&e.body.sender&&"worker"===e.body.sender&&E.close(langProvider.getText("conversation-finished")),"shake"===e.cmd){if(0!==$("#client-"+e.cmicrotime).length)return;Message.addShakeMessage(e,n)}if("image"===e.cmd){if(0!==$("#image-"+e.cmicrotime).length)return;Message.addImageMessage(e,n)}"block"===e.cmd&&E.close(),"force"===e.cmd&&(m(e.body),window.parent.postMessage("$CMD_FORCE","*")),"transfer"===e.cmd&&m(e.body),"reassign"===e.cmd&&m(e.body),"invite"===e.cmd&&(m(e.body),window.parent.postMessage("$CMD_INVITE","*"))}function k(e,n){var o=e.history;"0"!==o&&0!==o&&o&&Message.addHistoryTip()}function M(){window.parent.postMessage("$NO_WORKER_ONLINE","*"),"c9j7lej2dfdu"===window.DBKF.configs.COMPANY_ID&&$("#mobile-input").attr("placeholder",langProvider.getText("mobile-or-wechat")),$(".box-header .connect-info").hide(),$(".box-header .connected").hide(),$(".chat-box .box-comment").show(),$(".box-header .comment-info").show(),$(".chat-box").addClass("offline")}function _(e,n,o){n||(n=250);var i,t;return function(){var a=o||this,s=+new Date,r=arguments;i&&i+n>s?(clearTimeout(t),t=setTimeout(function(){i=s,e.apply(a,r)},n)):(i=s,e.apply(a,r))}}function x(){return!!window.IS_IN_YUNQUE_FRAME}function C(e){var n=e.yqLogoPosition;x()&&!c()&&"undefined"!=typeof e.frame_yqLogoPosition&&(n=e.frame_yqLogoPosition),"undefined"==typeof n?c()?$(".chat-box").addClass("yq-logo-bottom"):$(".chat-box").addClass("yq-logo-bottom"):"center"===n?$(".chat-box").addClass("yq-logo-center"):$(".chat-box").addClass("yq-logo-bottom")}function S(){var e="https://yunque360.com?utm_source=logo&utm_medium=logo&utm_campaign=logo&utm_content="+window.DBKF.configs.COMPANY_ID;$('a[href="http://yunque360.com"]').attr("href",e)}Commet.prototype.onopen=function(n){e(),o(n),u(),k(n)},Commet.prototype.onmessage=function(e){e=e.data;var n=document.getElementById("first-render-div");if(n)y(e.messages);else{var o=document.createElement("div");if(o.style.display="none",o.setAttribute("id","first-render-div"),document.body.appendChild(o),e.messages)if(0===e.messages.length)window.parent.postMessage("$HAS_NEW_USER_MESSAGE=0","*");else{for(var i=e.messages.length-1;i>=0;i--){var t=e.messages[i];if(-1!==["worker","autoreply"].indexOf(t.cmd)){window.parent.postMessage("$LATEST_MESSAGE_IS_USER=0","*"),window.LATEST_MESSAGE_IS_USER=!1;break}if(-1!==["user","image","shake"].indexOf(t.cmd)){window.parent.postMessage("$LATEST_MESSAGE_IS_USER=1","*"),window.LATEST_MESSAGE_IS_USER=!0;break}}for(var a=!1,s=0;s<e.messages.length;s++){var r=e.messages[s];if(-1!==["user","image","shake"].indexOf(r.cmd)){window.parent.postMessage("$HAS_NEW_USER_MESSAGE=1","*"),a=!0;break}}a||window.parent.postMessage("$HAS_NEW_USER_MESSAGE=0","*")}Message.renderHistoryMessages(e.messages)}if(e.messages&&0!==e.messages.length)for(var s=0;s<e.messages.length;s++){var c=e.messages[s];-1!==["worker","autoreply","image"].indexOf(c.cmd)&&window.parent.postMessage("$HAS_NEW_WORKER_MESSAGE","*"),-1!==["worker","autoreply"].indexOf(c.cmd)&&window.parent.postMessage("$NEW_WORKER_MESSAGE="+c.body,"*")}},Commet.prototype.onclose=function(e){e||(e=langProvider.getText("offline-reconnect")),$("#input-textarea").attr("disabled","disabled"),$("#input-textarea").attr("placeholder",e),$("#input-textarea").addClass("disconnected"),$("#input-textarea").val(e),$("#send-btn").hide(),$(".actions a").hide()},Commet.prototype.onerror=function(){},Commet.prototype.onsendSuccess=function(e){$("#client-"+e).removeClass("sending")},Commet.prototype.onsendError=function(e){$("#client-"+e).addClass("error")},Commet.prototype.onNoWorker=function(){M(),o({},!1)},Commet.prototype.onNetworkFail=function(){Message.addNetworkFailMessage()};var E=new Commet(window.DBKF.configs);S();var D=new YunqueImage(window.DBKF.configs)}function listenEvent(){Sound.init(),$("#play-sound-icon, #not-play-sound-icon").click(function(){Sound.toggleSound()}),$("#minimize-btn").click(function(){window.parent.postMessage("$MINIMIZE","*")}),$("#back-btn").click(function(){window.parent.postMessage("$GO_BACK","*")}),$("#submit-comment-btn").click(function(){CommentClass.submit()}),$("body").click(function(){"none"!==$("#emojiHolder").css("display")&&$("#emojiHolder").hide()}),window.onfocus=function(){window.parent.postMessage("$WINDOW_FOCUSED","*")}}function chooseEmoji(e){var n=document.getElementById("input-textarea");n.value+=e,triggerEmoji()}function triggerEmoji(e){return(e||window.event)&&(e=e||window.event,e.stopPropagation?e.stopPropagation():e.cancelBubble=!0),$("#emojiHolder").css("bottom",$(".chat-box").outerHeight()-$(".chat-history").outerHeight()-40-30),$("#emojiHolder").toggle(),!1}function renderEmoji(e){return e.replace(/\$.+?\$/g,function(e){var n=e.replace(/\$/g,"");return'<img src="//'+window.location.host+"/images/"+n+'.png" class="emoji-img">'})}function listenMessage(){window.addEventListener("message",function(e){var n=e.data;if(n.indexOf&&-1!==n.indexOf("$COMPANY_DATA")){var o=JSON.parse(n.split("COMPANY_DATA=")[1]);window.DBKF.configs.COMPANY_ID=o.company_id,window.DBKF.configs.referrer=o.referrer,window.DBKF.configs.pageTitle=o.title,window.DBKF.configs.pv=o.pv,getCompanyInfo(window.DBKF.configs.COMPANY_ID),chat()}},!1)}function isMobile(){var e=!1;return function(n){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|BDNuomiAppAndroid/i.test(n)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(n.substr(0,4)))&&(e=!0)}(navigator.userAgent||navigator.vendor||window.opera),e||window.screen&&window.screen.width&&window.screen.width<=720&&(e=!0),e}function getCompanyInfo(e){$.ajax({type:"GET",dataType:"json",cache:!1,url:window.DBKF.configs.POLLING_SITE+"/company?id="+e,success:function(e,n){var o=JSON.stringify(e.data);window.DBKF.configs.windowrule=JSON.parse(e.data.windowrule||"[]"),window.DBKF.configs.mwindowrule=JSON.parse(e.data.mwindowrule||"[]"),window.DBKF.configs.uirule=JSON.parse(e.data.uirule||"[]"),window.parent.postMessage("$COMPANY_INFO="+o,"*")}})}function isInIframe(){try{if(window.location==window.parent.location)return!1;if(-1!==window.parent.location.hostname.indexOf("uclient"))return!1}catch(e){return!0}return!1}function isInYunqueFrame(){try{if(window.location==window.parent.location)return!1;if(-1!==window.parent.location.hostname.indexOf("uclient")||-1!==window.parent.location.href.indexOf("localhost:9000"))return!0}catch(e){return!0}return!1}function hideMinimize(){$("#minimize-btn").hide(),$("#back-btn").show()}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e};if(window.addEventListener=window.addEventListener||function(e,n){window.attachEvent("on"+e,n)},"object"===("undefined"==typeof localStorage?"undefined":_typeof(localStorage)))try{localStorage.setItem("localStorage",1),localStorage.removeItem("localStorage")}catch(e){Storage.prototype._setItem=Storage.prototype.setItem,Storage.prototype.setItem=function(){}}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e};!function(e){if("function"==typeof define&&define.amd)define(e);else if("object"===("undefined"==typeof exports?"undefined":_typeof(exports)))module.exports=e();else{var n=window.Cookies,o=window.Cookies=e();o.noConflict=function(){return window.Cookies=n,o}}}(function(){function e(){for(var e=0,n={};e<arguments.length;e++){var o=arguments[e];for(var i in o)n[i]=o[i]}return n}function n(o){function i(n,t,a){window.localStorage&&localStorage.setItem(n,t);var s;if("undefined"!=typeof document){if(arguments.length>1){if(a=e({path:"/"},i.defaults,a),"number"==typeof a.expires){var r=new Date;r.setMilliseconds(r.getMilliseconds()+864e5*a.expires),a.expires=r}try{s=JSON.stringify(t),/^[\{\[]/.test(s)&&(t=s)}catch(c){}return t=o.write?o.write(t,n):encodeURIComponent(String(t)).replace(/%(23|24|26|2B|3A|3C|3E|3D|2F|3F|40|5B|5D|5E|60|7B|7D|7C)/g,decodeURIComponent),n=encodeURIComponent(String(n)),n=n.replace(/%(23|24|26|2B|5E|60|7C)/g,decodeURIComponent),n=n.replace(/[\(\)]/g,escape),document.cookie=[n,"=",t,a.expires&&"; expires="+a.expires.toUTCString(),a.path&&"; path="+a.path,a.domain&&"; domain="+a.domain,a.secure?"; secure":""].join("")}n||(s={});for(var d=document.cookie?document.cookie.split("; "):[],l=/(%[0-9A-Z]{2})+/g,u=0;u<d.length;u++){var m=d[u].split("="),w=m[0].replace(l,decodeURIComponent),g=m.slice(1).join("=");'"'===g.charAt(0)&&(g=g.slice(1,-1));try{if(g=o.read?o.read(g,w):o(g,w)||g.replace(l,decodeURIComponent),this.json)try{g=JSON.parse(g)}catch(c){}if(n===w){s=g;break}n||(s[w]=g)}catch(c){}}return s}}return i.set=i,i.get=function(e){return window.localStorage?localStorage.getItem(e):i(e)},i.getJSON=function(){return i.apply({json:!0},[].slice.call(arguments))},i.defaults={},i.remove=function(n,o){i(n,"",e(o,{expires:-1}))},i.withConverter=n,i}return n(function(){})}),window.DBKF={},window.DBKF.configs={POLLING_SITE:"//imapi.yunque360.com",API_ADDRESS:"//api.yunque360.com/v1",COMPANY_IMAGE_CDN:"//yunque-company.cdn.yunque360.com",POLLING_INTERVAL:18e3,IMAGE_SERVER:"//yttest001.img-cn-hangzhou.aliyuncs.com",CHAT_IMAGE_SERVER:"//img.yunque123.cn",COMPANY_IMAGE_SERVER:"//img.yunque123.cn"},function(){var e=function(){for(var e={},n=window.location.search.substring(1),o=n.split("&"),i=0;i<o.length;i++){var t=o[i].split("=");if("undefined"==typeof e[t[0]])e[t[0]]=decodeURIComponent(t[1]);else if("string"==typeof e[t[0]]){var a=[e[t[0]],decodeURIComponent(t[1])];e[t[0]]=a}else e[t[0]].push(decodeURIComponent(t[1]))}return e}();e.company_id&&(window.DBKF.configs.COMPANY_ID=e.company_id),e.referrer&&(window.DBKF.configs.referrer=e.referrer),e.pv&&(window.DBKF.configs.pv=e.pv),e.extra_uid&&(window.DBKF.configs.extra_uid=e.extra_uid)}(),Cookies.defaults.expires=365;var _createClass=function(){function e(e,n){for(var o=0;o<n.length;o++){var i=n[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(n,o,i){return o&&e(n.prototype,o),i&&e(n,i),n}}(),Utils=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"uuid",value:function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}},{key:"isMobile",value:function n(){var n=!1;return function(e){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|BDNuomiAppAndroid/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4)))&&(n=!0)}(navigator.userAgent||navigator.vendor||window.opera),n||window.screen&&window.screen.width&&window.screen.width<=720&&(n=!0),n}},{key:"isIOSVersion10",value:function(){if(!this.isMobile())return!1;if(window.MSStream)return!1;var e,n=navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/);if(void 0!==n&&null!==n){e=[parseInt(n[1],10),parseInt(n[2],10),parseInt(n[3]||0,10)];var e=parseFloat(e.join("."));return 0===e.toString().indexOf("11")?!0:0===e.toString().indexOf("10")?!0:0===e.toString().indexOf("9")}return!1}},{key:"isIE",value:function o(e,n){var o,i="IE",t=document.createElement("B"),a=document.documentElement;return e&&(i+=" "+e,n&&(i=n+" "+i)),t.innerHTML="<!--[if "+i+']><b id="iecctest"></b><![endif]-->',a.appendChild(t),o=!!document.getElementById("iecctest"),a.removeChild(t),o}},{key:"islowerIE10",value:function(){return this.isIE(8)&&this.isIE(9)}},{key:"islowerIE9",value:function(){return this.isIE(8)}},{key:"isFixedViewportMobile",value:function(){return this.isMobile()&&this.isInCustomerFrame()&&window.DBKF&&window.DBKF.configs&&"ca3iv6nheabp"===window.DBKF.configs.COMPANY_ID?!0:this.isMobile()&&window.matchMedia("(min-width: 600px)").matches}},{key:"isInCustomerFrame",value:function(){try{if(window.location==window.parent.location)return!1;if(-1!==window.parent.location.hostname.indexOf("uclient")||-1!==window.parent.location.href.indexOf("localhost:9000"))return!1}catch(e){return!0}return!0}}]),e}(),_createClass=function(){function e(e,n){for(var o=0;o<n.length;o++){var i=n[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(n,o,i){return o&&e(n.prototype,o),i&&e(n,i),n}}(),Sound=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"init",value:function(){this.isMute=!(!Cookies.get("isMute")||"true"!==Cookies.get("isMute")),this.displaySoundIcon()}},{key:"displaySoundIcon",value:function(){this.isMute?($("#play-sound-icon").hide(),$("#not-play-sound-icon").show()):($("#not-play-sound-icon").hide(),$("#play-sound-icon").show())}},{key:"toggleSound",value:function(){this.isMute=!this.isMute,Cookies.set("isMute",this.isMute),this.isMute?($("#play-sound-icon").hide(),$("#not-play-sound-icon").show()):($("#not-play-sound-icon").hide(),$("#play-sound-icon").show())}},{key:"getInternetExplorerVersion",value:function(){var e=-1;if("Microsoft Internet Explorer"==navigator.appName){var n=navigator.userAgent,o=new RegExp("MSIE ([0-9]{1,}[.0-9]{0,})");null!=o.exec(n)&&(e=parseFloat(RegExp.$1))}return e}},{key:"playNewMessage",value:function(){if(!(window.DBKF&&window.DBKF.configs&&window.DBKF.configs.uirule&&"false"===window.DBKF.configs.uirule.enableSound||Utils.isMobile()||this.isMute)){var e=document.getElementById("new-message-sound");e&&e.play&&e.play()}}},{key:"playSentMessage",value:function(){if(!Utils.isMobile()&&!this.isMute){
var e=document.getElementById("sent-message-sound");e&&e.play&&e.play()}}},{key:"audioWarmUp",value:function(){function n(){o.volume=0,e.playNewMessage(),o.volume=1}if(!Utils.isMobile()&&navigator.userAgent.match(/(iPod|iPhone|iPad|XiaoMi)/)){var o=document.getElementById("new-message-sound");window.addEventListener("touchstart",n,!1),o.addEventListener("play",function(){window.removeEventListener("touchstart",n,!1)},!1)}}}]),e}(),_createClass=function(){function e(e,n){for(var o=0;o<n.length;o++){var i=n[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(n,o,i){return o&&e(n.prototype,o),i&&e(n,i),n}}(),YunqueImage=function(){function e(n){_classCallCheck(this,e),this.API_ADDRESS=n.POLLING_SITE}return _createClass(e,[{key:"sendImage",value:function(e){var n=this;this.file=e;try{var o=e.name.split(".").pop();return this.getToken(o).then(this.uploadFile.bind(this)).then(function(){return n.fileName})}catch(i){}}},{key:"getToken",value:function(e){var n={ext:e,type:"chat"};return $.post(this.API_ADDRESS+"/uptoken",n)}},{key:"uploadFile",value:function(e){var n=e.data,o=n.host;-1!==o.indexOf("http")&&(o=o.slice(5));var i=n.viewhost,t=n.access_id,a=n.policy,s=n.signature,r=n.filename;this.fileName=i+"/"+r+"!default";var c=new FormData;return c.append("OSSAccessKeyId",t),c.append("policy",a),c.append("Signature",s),c.append("key",r),c.append("file",this.file),$.ajax({url:o,type:"POST",data:c,processData:!1,contentType:!1})}}]),e}(),_createClass=function(){function e(e,n){for(var o=0;o<n.length;o++){var i=n[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(n,o,i){return o&&e(n.prototype,o),i&&e(n,i),n}}(),Message=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"addAdsMessage",value:function(e){var n=$(".msg-history");n.length?n.after(this.getAdsMessage(e)):$("#chat-history").prepend(this.getAdsMessage(e))}},{key:"addTempClientMessage",value:function(e){e.body=filterXSS(e.body),$("#chat-history").append(this.getClientMessage(e)),this.scrollBottom()}},{key:"addClientMessage",value:function(e){var n=arguments.length<=1||void 0===arguments[1]?!1:arguments[1];n?$("#chat-history").prepend(this.getClientMessage(e)):($("#chat-history").append(this.getClientMessage(e)),this.scrollBottom())}},{key:"addAgentMessage",value:function(e){var n=arguments.length<=1||void 0===arguments[1]?!1:arguments[1];n?$("#chat-history").prepend(this.getAgentMessage(e)):($("#chat-history").append(this.getAgentMessage(e)),this.scrollBottom()),$("a").attr("target","_blank")}},{key:"addShakeMessage",value:function(e){var n=arguments.length<=1||void 0===arguments[1]?!1:arguments[1];n?$("#chat-history").prepend(this.getShakeMessage(e)):($("#chat-history").append(this.getShakeMessage(e)),this.scrollBottom())}},{key:"addImageMessage",value:function(e){var n=arguments.length<=1||void 0===arguments[1]?!1:arguments[1];n?$("#chat-history").prepend(this.getImageMessage(e)):($("#chat-history").append(this.getImageMessage(e)),this.scrollBottom())}},{key:"addInfoMessage",value:function(e){var n=arguments.length<=1||void 0===arguments[1]?!1:arguments[1];n?$("#chat-history").prepend(this.getInfoMessage(e)):($("#chat-history").append(this.getInfoMessage(e)),this.scrollBottom())}},{key:"addHistoryTip",value:function(e){$("#chat-history").prepend(this.getHistoryTip(e))}},{key:"addDisconnectMessage",value:function(){$("#chat-history").append(this.getDisconnectMessage())}},{key:"addNetworkFailMessage",value:function(){$("#chat-history").append(this.getNetworkFailMessage())}},{key:"getAdsMessage",value:function(e){var n='\n        <div class="msg-wrapper msg-ads">\n              '+e+"\n              </div>\n        </div>\n      ";return n}},{key:"getClientMessage",value:function(e){var n='\n          <div class="msg-wrapper msg-client" id="client-'+e.cmicrotime+'">\n            <div class="bubble">\n              <i class="iconfont error">&#xe606;</i>\n              <i class="iconfont sending">&#xe609;</i>\n              <div class="bubble-content">\n              '+e.body+"\n              </div>\n            </div>\n          </div>\n        ";return renderEmoji(n)}},{key:"getAgentMessage",value:function(e){var n='\n          <div class="msg-wrapper msg-agent">\n            <div class="name">'+e.agentName+'</div>\n            <div class="bubble">\n              <div>'+e.body+"</div>\n            </div>\n          </div>\n        ";return n}},{key:"getShakeMessage",value:function(e){return'\n          <div class="msg-wrapper msg-info" id="client-'+e.cmicrotime+'">\n            <span style="position: relative"><i class="iconfont error">&#xe606;</i>'+langProvider.getText("send-vibrate-msg")+"</span>\n          </div>\n        "}},{key:"getInfoMessage",value:function(e){return'\n          <div class="msg-wrapper msg-info" id="info-'+e.cmicrotime+'">\n            '+e.body+"\n          </div>\n        "}},{key:"getImageMessage",value:function(e){return'\n          <div class="msg-wrapper msg-image" id="image-'+e.cmicrotime+'">\n            <img src="'+e.body+'" >\n          </div>\n        '}},{key:"getHistoryTip",value:function(e){return e?'\n          <div class="msg-wrapper msg-info msg-history" id="'+e+'">\n          '+langProvider.getText("history-tip")+"\n          </div>\n        ":'\n          <div class="msg-wrapper msg-info msg-history">\n            '+langProvider.getText("history-tip")+"\n          </div>\n        "}},{key:"getDisconnectMessage",value:function(){return'\n          <div class="msg-wrapper msg-info">\n            '+langProvider.getText("manual-disconnect")+"\n\n          </div>\n        "}},{key:"getNetworkFailMessage",value:function(){return'\n          <div class="msg-wrapper msg-info">\n            '+langProvider.getText("network-fail")+"\n          </div>\n        "}},{key:"addHistoryMsgs",value:function(e){var n=this,o={company_id:window.DBKF.configs.COMPANY_ID,uid:Cookies.get("uid")};e&&(o.microtime=e),$.post(window.DBKF.configs.API_ADDRESS+"/chat/chat/web-history",o,function(e){var o=e.result.data;$(".chat-history .msg-history").remove(),n.renderHistoryMessages(o,!0),e.result&&e.result.more&&n.addHistoryTip(e.result.data[0].microtime)})}},{key:"scrollBottom",value:function(){var e=document.getElementById("chat-history");$(e).scrollTop($(e)[0].scrollHeight)}},{key:"renderHistoryMessages",value:function(e){var n=arguments.length<=1||void 0===arguments[1]?!1:arguments[1];if(n)for(var o=e.length-1;o>=0;o--){var i=e[o];this.renderHistoryMessage(i,n)}else for(var t in e){var i=e[t];this.renderHistoryMessage(i,n)}}},{key:"renderHistoryMessage",value:function(n,o){if("user"===n.cmd){if(n.cmicrotime&&0!==$("#client-"+n.cmicrotime).length)return;e.addClientMessage(n,o)}if("worker"===n.cmd&&(n.agentName=window.DBKF.agentName,window.LATEST_MESSAGE_IS_USER===!0||Sound.playNewMessage(),e.addAgentMessage(n,o)),"autoreply"===n.cmd&&(n.agentName=window.DBKF.agentName,window.LATEST_MESSAGE_IS_USER===!0||Sound.playNewMessage(),e.addAgentMessage(n,o)),"shake"===n.cmd){if(0!==$("#client-"+n.cmicrotime).length)return;e.addShakeMessage(n,o)}if("image"===n.cmd){if(0!==$("#image-"+n.cmicrotime).length)return;e.addImageMessage(n,o)}}}]),e}(),_createClass=function(){function e(e,n){for(var o=0;o<n.length;o++){var i=n[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(n,o,i){return o&&e(n.prototype,o),i&&e(n,i),n}}(),Commet=function(){function e(n){_classCallCheck(this,e),this.url=n.POLLING_SITE.replace("ws://","//"),this.company_id=n.COMPANY_ID,this.POLLING_INTERVAL=n.POLLING_INTERVAL,this.connected=!1,this.uid="",this.send_queue=[],this.sending=!1,this.total=0,this.reLoopCount=0,jQuery.support.cors=!0,this.connect()}return _createClass(e,[{key:"send",value:function(e){this.send_queue.push(e),this.connected&&!this.sending&&this.sendMessage()}},{key:"sendMessage",value:function(){if(0===this.send_queue.length)return void(this.sending=!1);var e=this,n=this.send_queue.pop();this.sending=!0,$.ajax({type:"POST",dataType:"json",url:this.url+"/send",data:{uid:e.uid,company_id:e.company_id,body:n.body,cmd:n.cmd,cmicrotime:n.cmicrotime,worker_name:e.worker_name},success:function(o,i){"1"==o.success?(n.cmicrotime&&e.onsendSuccess(n.cmicrotime),e.sendMessage()):(console.log("ErrorMessage: "+o),n.cmicrotime&&e.onsendError(n.cmicrotime),e.sendMessage())},error:function(o,i,t){var a={};a.data=i,e.onerror(a),n.cmicrotime&&e.onsendError(n.cmicrotime),e.sendMessage()}})}},{key:"checkHeadless",value:function(){return/bot|googlebot|crawler|spider|robot|crawling/i.test(navigator.userAgent)?!1:!(window._phantom||window.__phantomas||window.Buffer||window.emit||window.spawn||window.webdriver||window.domAutomation||window.domAutomationController)}},{key:"connect",value:function(){if(this.checkHeadless()){this.cleanStuff();var e=this,n={company_id:e.company_id,referrer:window.DBKF.configs.referrer?window.DBKF.configs.referrer:"",title:window.DBKF.configs.pageTitle?window.DBKF.configs.pageTitle:"",pv:window.DBKF.configs.pv?window.DBKF.configs.pv:"",platform:this.checkPlatform()},o=void 0;window.DBKF.configs.extra_uid&&"undefined"!==window.DBKF.configs.extra_uid&&(o=window.DBKF.configs.extra_uid),Cookies.get("uid")&&"undefined"!==Cookies.get("uid")&&(o=Cookies.get("uid")),o&&(n.uid=o),$.ajax({type:"POST",dataType:"json",url:this.url+"/connect",data:n,crossDomain:!0,xhrFields:{withCredentials:!0},success:function(n,o){1===n.success?(n=n.data,e.uid=n.uid,e.worker_name=n.worker_name,Cookies.set("uid",e.uid),Utils.isIOSVersion10()&&window.parent.postMessage("$YUNQUE_EXTRA_UID="+e.uid,"*"),window.parent.postMessage("$YUNQUE_UID="+e.uid,"*"),e.connected=!0,e.loop(),e.onopen(n)):(n.message="Big brother is watching you.",(n.message="No worker online, please connect later.")&&(n=n.data,e.uid=n.uid,Cookies.set("uid",e.uid),Utils.isIOSVersion10()&&window.parent.postMessage("$YUNQUE_EXTRA_UID="+e.uid,"*"),e.onNoWorker()))},error:function(e,n,o){e.getAllResponseHeaders()&&alert(langProvider.getText("connect-failed"))}})}}},{key:"loop",value:function(){var e=this;this.connected&&e.pulling!==!0&&(e.pulling=!0,$.ajax({type:"POST",dataType:"json",url:e.url+"/pull",timeout:this.POLLING_INTERVAL,data:{uid:e.uid,company_id:e.company_id,from:e.total,worker_name:e.worker_name},success:function(n,o){if("1"==n.success)e.reLoopCount=0,e.total=n.data.total,e.onmessage(n);else if("0"==n.success){if("Please connect first."===n.message)return void e.close(langProvider.getText(langProvider.getText("conversation-finished")))}else console.log("ErrorMessage: "+n);e.pulling=!1,e.loop()},error:function(n,o,i){e.reLoopCount>=3?(e.onNetworkFail(),e.pulling=!1,e.close()):setTimeout(function(){e.reLoopCount++,e.pulling=!1,e.loop()},5e3)}}))}},{key:"close",value:function(e){this.connected=!1,this.onclose(e)}},{key:"checkPlatform",value:function(){var e=!1;!function(n){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|BDNuomiAppAndroid/i.test(n)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(n.substr(0,4)))&&(e=!0)}(navigator.userAgent||navigator.vendor||window.opera),e||window.screen&&window.screen.width&&window.screen.width<=720&&(e=!0);var n=e?"mobile":"pc";return n}},{key:"cleanStuff",value:function(){$("#input-textarea").val("")}}]),e}(),_createClass=function(){function e(e,n){for(var o=0;o<n.length;o++){var i=n[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(n,o,i){return o&&e(n.prototype,o),i&&e(n,i),n}}(),CommentClass=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"submit",value:function(){if(!this.sending){this.triggerBaiduStatisticsByComment();var e=window.DBKF.configs.API_ADDRESS,n=document.getElementById("mobile-input");if(!n||!n.value)return void $(".comment-alert").show();var o=document.getElementById("comment-input");if(!o||!o.value)return void $(".comment-alert").show();this.sending=!0,$.ajax({type:"POST",dataType:"json",url:e+"/chat/chat/message",data:{uid:Cookies.get("uid"),company_id:window.DBKF.configs.COMPANY_ID,mobile:n.value,message:o.value,referrer:window.DBKF.configs.referrer?window.DBKF.configs.referrer:"",platform:Utils.isMobile()?"mobile":"pc",firsturl:window.DBKF.configs.pv?window.DBKF.configs.pv:""},success:function(e,n){$(".after-submit").show(),$(".box-comment .body").hide(),$(".box-comment .comment-alert").hide(),this.sending=!1},error:function(e,n,o){alert(langProvider.getText("submit-failed")),this.sending=!1}})}}},{key:"triggerBaiduStatisticsByComment",value:function(){window.parent.postMessage("$YUNQUE_BAIDU_SEND_COMMENT","*")}}]),e}();listenMessage(),$(function(){if(isMobile()&&$("body").addClass("is-mobile"),listenEvent(),isInYunqueFrame()&&(window.addEventListener("message",function(e){var n=e.data;"string"==typeof n&&-1!==n.indexOf("$IS_IN_YUNQUE_FRAME")&&(window.IS_IN_YUNQUE_FRAME=!0)}),window.parent.postMessage("$DOCUMENT_READY","*")),isInIframe()){if(isInYunqueFrame())return;window.parent.postMessage("$DOCUMENT_READY","*")}else{if(!window.DBKF.configs.COMPANY_ID)return alert(langProvider.getText("invalid-window")),void $("body").html("");hideMinimize(),chat()}});